<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | The Limelight</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #dee2e6;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --primary: #4a69bd;
            --danger: #e63946;
            --success: #2a9d8f;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition-speed: 0.3s;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-light); color: var(--text-dark); -webkit-font-smoothing: antialiased; }
        .admin-container { display: flex; height: 100vh; }
        .sidebar { width: 240px; background: var(--bg-white); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 2rem 0; }
        .sidebar-header { 
            padding: 0 2rem; 
            margin-bottom: 2rem; 
            font-weight: 600; 
            font-size: 1.2rem;
            text-align: center;
        }
        .sidebar-logo {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav a { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 2rem; color: var(--text-muted); text-decoration: none; font-weight: 500; transition: all 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-nav a.active, .sidebar-nav a:hover { color: var(--text-dark); background-color: var(--bg-light); border-left-color: var(--primary); }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .main-header h1 { font-size: 1.8rem; margin: 0; }
        .btn { border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .card { background: var(--bg-white); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; }
        .card-body { padding: 2rem; }
        .card-header { padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        #listContainer table { width: 100%; border-collapse: collapse; }
        #listContainer th, #listContainer td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        #listContainer th { font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
        .sortable-ghost { opacity: 0.4; }
        .drag-handle { cursor: move; color: var(--text-muted); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; grid-column: span 2; }
        .form-group.col-span-1 { grid-column: span 1; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; }
        .form-group textarea { min-height: 120px; }
        .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        #formContainer { display: none; }
        #image-upload-container .preview { margin-top: 1rem; max-width: 200px; border-radius: 6px; }
        #image-upload-container progress { width: 100%; margin-top: 0.5rem; }
        #editor { height: 300px; }
        
        /* Featured toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Dashboard Styles */
        .dashboard-welcome {
            background: linear-gradient(135deg, var(--primary), #3c5aa6);
            color: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .dashboard-welcome h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .dashboard-welcome p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform var(--transition-speed);
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        .stat-card.articles .stat-icon { color: var(--primary); }
        .stat-card.authors .stat-icon { color: var(--success); }
        .stat-card.categories .stat-icon { color: #f39c12; }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        /* Validation Styles */
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }
        .form-group.error input, .form-group.error textarea {
            border-color: var(--danger);
        }
        .form-group.error .error-message {
            display: block;
        }
        .success-message {
            color: var(--success);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }
        .form-group.success .success-message {
            display: block;
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: var(--success);
        }
        .notification.error {
            background-color: var(--danger);
        }
        
        /* Preview Button */
        .preview-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 1rem;
            background-color: var(--success);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }
        .preview-link:hover {
            background-color: #21867a;
        }
    </style>
</head>
<body>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">THE LIMELIGHT</div>
                <div>Admin Panel</div>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="#" class="nav-link" data-view="posts"><i class="fas fa-newspaper"></i> Posts</a>
                <a href="#" class="nav-link" data-view="featured"><i class="fas fa-star"></i> Featured Articles</a>
                <a href="#" class="nav-link" data-view="categories"><i class="fas fa-folder"></i> Categories</a>
                <a href="#" class="nav-link" data-view="authors"><i class="fas fa-user-edit"></i> Authors</a>
                <a href="#" class="nav-link" data-view="contact"><i class="fas fa-envelope"></i> Contact Page</a>
            </nav>
        </aside>
        <main class="main-content">
            <header class="main-header">
                <h1 id="viewTitle">Dashboard</h1>
                <button id="createNewBtn" class="btn btn-primary" style="display: none;">Create New</button>
            </header>
            
            <!-- Dashboard View -->
            <div id="dashboardView">
                <div class="dashboard-welcome">
                    <h2>Welcome to The Limelight Admin Panel</h2>
                    <p>Manage your content, track statistics, and publish new articles with ease.</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card articles">
                        <div class="stat-icon"><i class="fas fa-newspaper"></i></div>
                        <div class="stat-number" id="articlesCount">0</div>
                        <div class="stat-label">Articles</div>
                    </div>
                    <div class="stat-card authors">
                        <div class="stat-icon"><i class="fas fa-user-edit"></i></div>
                        <div class="stat-number" id="authorsCount">0</div>
                        <div class="stat-label">Authors</div>
                    </div>
                    <div class="stat-card categories">
                        <div class="stat-icon"><i class="fas fa-folder"></i></div>
                        <div class="stat-number" id="categoriesCount">0</div>
                        <div class="stat-label">Categories</div>
                    </div>
                </div>
            </div>
            
            <section id="listContainer" class="card" style="display: none;"></section>
            <section id="formContainer" class="card card-body" style="display: none;"></section>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://whklfmxjknhucguzvpob.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indoa2xmbXhqa25odWNndXp2cG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTY5MjIsImV4cCI6MjA3Mzg3MjkyMn0.5Y2an8aYFc5wY64VmRJmnblYBPwLLs_CR9UXJ4XuzjM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const viewTitle = document.getElementById('viewTitle');
        const createNewBtn = document.getElementById('createNewBtn');
        const listContainer = document.getElementById('listContainer');
        const formContainer = document.getElementById('formContainer');
        const dashboardView = document.getElementById('dashboardView');
        const navLinks = document.querySelectorAll('.nav-link');
        const notification = document.getElementById('notification');
        let currentView = 'dashboard';
        let editingId = null;
        let quill;
        let postsSortable = null;

        // Show notification
        function showNotification(message, type = 'success') {
            notification.innerHTML = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Validate slug format
        function validateSlug(slug) {
            const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
            return slugRegex.test(slug);
        }

        // Switch between views
        function switchView(view) {
            currentView = view;
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === view));
            
            // Hide all views
            dashboardView.style.display = 'none';
            listContainer.style.display = 'none';
            formContainer.style.display = 'none';
            
            // Show selected view
            if (view === 'dashboard') {
                viewTitle.textContent = 'Dashboard';
                createNewBtn.style.display = 'none';
                dashboardView.style.display = 'block';
                loadDashboardStats();
            } else {
                const viewName = view.charAt(0).toUpperCase() + view.slice(1);
                viewTitle.textContent = viewName;
                createNewBtn.style.display = 'block';
                createNewBtn.textContent = `Create New ${view === 'featured' ? 'Featured Article' : viewName.slice(0, -1)}`;
                listContainer.style.display = 'block';
                loadData();
            }
            
            hideForm();
        }

        function showForm() {
            listContainer.style.display = 'none';
            createNewBtn.style.display = 'none';
            formContainer.style.display = 'block';
        }

        function hideForm() {
            listContainer.style.display = 'block';
            createNewBtn.style.display = 'block';
            formContainer.style.display = 'none';
            editingId = null;
            formContainer.innerHTML = '';
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const { count: articlesCount } = await supabaseClient.from('posts').select('*', { count: 'exact', head: true });
                const { count: authorsCount } = await supabaseClient.from('authors').select('*', { count: 'exact', head: true });
                const { count: categoriesCount } = await supabaseClient.from('categories').select('*', { count: 'exact', head: true });
                
                document.getElementById('articlesCount').textContent = articlesCount || 0;
                document.getElementById('authorsCount').textContent = authorsCount || 0;
                document.getElementById('categoriesCount').textContent = categoriesCount || 0;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadData() {
            let content = '';
            if (currentView === 'posts') {
                const { data } = await supabaseClient.from('posts').select(`*, authors(full_name), categories(name)`).order('order_index', { ascending: true, nullsFirst: false });
                content = `<div class="card-header"><h2>Posts</h2></div><table><thead><tr><th>Order</th><th>Title</th><th>Author</th><th>Category</th><th>Featured</th><th>Actions</th></tr></thead><tbody id="postsTableBody">`;
                content += data.map(p => `<tr data-id="${p.id}" data-order="${p.order_index || 0}"><td><i class="fas fa-grip-vertical drag-handle"></i></td><td>${p.title}</td><td>${p.authors?.full_name || 'N/A'}</td><td>${p.categories?.name || 'N/A'}</td><td>${p.is_featured ? 'Yes' : 'No'}</td><td><button class="btn btn-secondary" onclick="editItem('${p.id}')">Edit</button> <button class="btn btn-danger" onclick="deleteItem('${p.id}')">Delete</button></td></tr>`).join('');
                content += `</tbody></table>`;
                
                // Initialize sortable after rendering
                setTimeout(() => {
                    const tbody = document.getElementById('postsTableBody');
                    if (tbody && postsSortable === null) {
                        postsSortable = Sortable.create(tbody, {
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            handle: '.drag-handle',
                            onEnd: function(evt) {
                                updatePostOrder();
                            }
                        });
                    }
                }, 100);
            } else if (currentView === 'featured') {
                const { data } = await supabaseClient.from('posts').select(`*, authors(full_name), categories(name)`).eq('is_featured', true).order('created_at', { ascending: false });
                content = `<div class="card-header"><h2>Featured Articles</h2></div><table><thead><tr><th>Title</th><th>Author</th><th>Category</th><th>Actions</th></tr></thead><tbody>`;
                content += data.map(p => `<tr><td>${p.title}</td><td>${p.authors?.full_name || 'N/A'}</td><td>${p.categories?.name || 'N/A'}</td><td><button class="btn btn-secondary" onclick="editItem('${p.id}')">Edit</button> <button class="btn btn-danger" onclick="toggleFeatured('${p.id}', ${p.is_featured})">${p.is_featured ? 'Unfeature' : 'Feature'}</button></td></tr>`).join('');
                content += `</tbody></table>`;
            } else if (currentView === 'categories') {
                const { data } = await supabaseClient.from('categories').select(`*, parent:parent_id(name)`).order('name');
                content = `<div class="card-header"><h2>Categories</h2></div><table><thead><tr><th>Name</th><th>Slug</th><th>Parent</th><th>Actions</th></tr></thead><tbody>`;
                content += data.map(c => `<tr><td>${c.name}</td><td>${c.slug}</td><td>${c.parent?.name || 'None'}</td><td><button class="btn btn-secondary" onclick="editItem('${c.id}')">Edit</button> <button class="btn btn-danger" onclick="deleteItem('${c.id}')">Delete</button></td></tr>`).join('');
                content += `</tbody></table>`;
            } else if (currentView === 'authors') {
                const { data } = await supabaseClient.from('authors').select(`*`).order('full_name');
                content = `<div class="card-header"><h2>Authors</h2></div><table><thead><tr><th>Name</th><th>Bio</th><th>Actions</th></tr></thead><tbody>`;
                content += data.map(a => `<tr><td>${a.full_name}</td><td>${a.bio ? a.bio.substring(0, 100) + '...' : 'N/A'}</td><td><button class="btn btn-secondary" onclick="editItem('${a.id}')">Edit</button> <button class="btn btn-danger" onclick="deleteItem('${a.id}')">Delete</button></td></tr>`).join('');
                content += `</tbody></table>`;
            } else if (currentView === 'contact') {
                const { data } = await supabaseClient.from('contact_page').select('*').single();
                content = `<div class="card-header"><h2>Contact Page</h2></div>`;
                content += `<div class="card-body"><form id="contactForm">`;
                content += `<div class="form-group"><label for="contact_email">Email</label><input type="email" id="contact_email" value="${data?.email || ''}" class="form-control"></div>`;
                content += `<div class="form-group"><label for="contact_phone">Phone</label><input type="text" id="contact_phone" value="${data?.phone || ''}" class="form-control"></div>`;
                content += `<div class="form-group"><label for="contact_address">Address</label><textarea id="contact_address" class="form-control">${data?.address || ''}</textarea></div>`;
                content += `<div class="form-actions"><button type="button" class="btn btn-primary" onclick="saveContact()">Save</button></div>`;
                content += `</form></div>`;
            }
            listContainer.innerHTML = content;
        }

        // Update post order after drag and drop
        async function updatePostOrder() {
            const rows = document.querySelectorAll('#postsTableBody tr');
            const updates = [];
            
            rows.forEach((row, index) => {
                const id = row.getAttribute('data-id');
                updates.push({
                    id: id,
                    order_index: index
                });
            });
            
            const { error } = await supabaseClient
                .from('posts')
                .upsert(updates);
            
            if (error) {
                showNotification('Error updating post order: ' + error.message, 'error');
            } else {
                showNotification('Post order updated successfully!');
            }
        }

        // Toggle featured status
        async function toggleFeatured(id, currentStatus) {
            const { error } = await supabaseClient
                .from('posts')
                .update({ is_featured: !currentStatus })
                .eq('id', id);
            
            if (error) {
                showNotification('Error updating featured status: ' + error.message, 'error');
            } else {
                showNotification(`Article ${!currentStatus ? 'featured' : 'unfeatured'} successfully!`);
                loadData(); // Refresh the list
            }
        }

        async function renderForm(data = {}) {
            let formHtml = '';
            if (currentView === 'posts' || currentView === 'featured') {
                const { data: authors } = await supabaseClient.from('authors').select('id, full_name');
                const { data: categories } = await supabaseClient.from('categories').select('id, name');
                formHtml = `
                    <div class="form-grid">
                        <div class="form-group col-span-1">
                            <label for="title">Title</label>
                            <input type="text" id="title" value="${data.title || ''}" required>
                        </div>
                        <div class="form-group col-span-1">
                            <label for="slug">Slug</label>
                            <input type="text" id="slug" value="${data.slug || ''}" required>
                            <div class="error-message">Invalid slug format. Use lowercase letters, numbers, and hyphens only. Example: my-article-title</div>
                        </div>
                        <div class="form-group">
                            <label for="excerpt">Excerpt</label>
                            <textarea id="excerpt">${data.excerpt || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <div id="editor">${data.content || ''}</div>
                        </div>
                        <div class="form-group col-span-1" id="image-upload-container">
                            <label for="image_upload">Featured Image</label>
                            <input type="file" id="image_upload" accept="image/*">
                            <progress id="upload-progress" value="0" max="100" style="display:none;"></progress>
                            <input type="hidden" id="image_url" value="${data.image_url || ''}">
                            <img id="image-preview" class="preview" src="${data.image_url || ''}" style="${data.image_url ? '' : 'display:none;'}">
                            <div class="success-message">Image uploaded successfully!</div>
                        </div>
                        <div class="form-group col-span-1">
                            <label for="author_id">Author</label>
                            <select id="author_id">${authors.map(a => `<option value="${a.id}" ${data.author_id === a.id ? 'selected' : ''}>${a.full_name}</option>`).join('')}</select>
                            <label for="category_id" style="margin-top:1rem;">Category</label>
                            <select id="category_id">${categories.map(c => `<option value="${c.id}" ${data.category_id === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select>
                            <label style="margin-top:1rem; display:flex; align-items:center;">
                                <input type="checkbox" id="is_featured" ${data.is_featured ? 'checked' : ''} style="width:auto; margin-right:0.5rem;"> Is Featured?
                            </label>
                        </div>
                    </div>
                `;
            } else if (currentView === 'categories') {
                 const { data: parentCategories } = await supabaseClient.from('categories').select('id, name').neq('id', editingId || '00000000-0000-0000-0000-000000000000');
                 formHtml = `
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" value="${data.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="slug">Slug</label>
                        <input type="text" id="slug" value="${data.slug || ''}" required>
                        <div class="error-message">Invalid slug format. Use lowercase letters, numbers, and hyphens only. Example: my-category</div>
                    </div>
                    <div class="form-group">
                        <label for="parent_id">Parent Category</label>
                        <select id="parent_id">
                            <option value="">None</option>
                            ${parentCategories.map(c => `<option value="${c.id}" ${data.parent_id === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>`;
            } else if (currentView === 'authors') {
                formHtml = `
                    <div class="form-group">
                        <label for="full_name">Full Name</label>
                        <input type="text" id="full_name" value="${data.full_name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="bio">Bio</label>
                        <textarea id="bio">${data.bio || ''}</textarea>
                    </div>
                    <div class="form-group" id="avatar-upload-container">
                        <label for="avatar_upload">Profile Image</label>
                        <input type="file" id="avatar_upload" accept="image/*">
                        <progress id="avatar-progress" value="0" max="100" style="display:none;"></progress>
                        <input type="hidden" id="avatar_url" value="${data.avatar_url || ''}">
                        <img id="avatar-preview" class="preview" src="${data.avatar_url || ''}" style="${data.avatar_url ? '' : 'display:none;'}">
                        <div class="success-message">Avatar uploaded successfully!</div>
                    </div>`;
            }
            
            formHtml += `<div class="form-actions">
                <button class="btn btn-primary" onclick="saveItem()">Save</button>
                <button class="btn btn-secondary" onclick="hideForm()">Cancel</button>
            </div>`;
            
            formContainer.innerHTML = formHtml;
            
            if (currentView === 'posts' || currentView === 'featured') {
                quill = new Quill('#editor', { theme: 'snow' });
                document.getElementById('image_upload').addEventListener('change', handleImageUpload);
                
                // Add slug validation
                const slugInput = document.getElementById('slug');
                slugInput.addEventListener('blur', function() {
                    const slugGroup = this.closest('.form-group');
                    if (!validateSlug(this.value)) {
                        slugGroup.classList.add('error');
                    } else {
                        slugGroup.classList.remove('error');
                    }
                });
            } else if (currentView === 'categories') {
                // Add slug validation
                const slugInput = document.getElementById('slug');
                slugInput.addEventListener('blur', function() {
                    const slugGroup = this.closest('.form-group');
                    if (!validateSlug(this.value)) {
                        slugGroup.classList.add('error');
                    } else {
                        slugGroup.classList.remove('error');
                    }
                });
            } else if (currentView === 'authors') {
                document.getElementById('avatar_upload').addEventListener('change', handleAvatarUpload);
            }
            
            showForm();
        }
        
        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const progressBar = document.getElementById('upload-progress');
            const uploadContainer = document.getElementById('image-upload-container');
            progressBar.style.display = 'block';
            progressBar.value = 0;

            const fileName = `${Date.now()}-${file.name}`;
            const { error } = await supabaseClient.storage.from('post_images').upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
            });

            if (error) {
                showNotification('Image upload failed: ' + error.message, 'error');
                progressBar.style.display = 'none';
            } else {
                const { data } = supabaseClient.storage.from('post_images').getPublicUrl(fileName);
                document.getElementById('image_url').value = data.publicUrl;
                document.getElementById('image-preview').src = data.publicUrl;
                document.getElementById('image-preview').style.display = 'block';
                progressBar.style.display = 'none';
                uploadContainer.classList.add('success');
                showNotification('Image uploaded successfully!');
            }
        }
        
        async function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const progressBar = document.getElementById('avatar-progress');
            const uploadContainer = document.getElementById('avatar-upload-container');
            progressBar.style.display = 'block';
            progressBar.value = 0;

            const fileName = `avatar-${Date.now()}-${file.name}`;
            const { error } = await supabaseClient.storage.from('author_avatars').upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
            });

            if (error) {
                showNotification('Avatar upload failed: ' + error.message, 'error');
                progressBar.style.display = 'none';
            } else {
                const { data } = supabaseClient.storage.from('author_avatars').getPublicUrl(fileName);
                document.getElementById('avatar_url').value = data.publicUrl;
                document.getElementById('avatar-preview').src = data.publicUrl;
                document.getElementById('avatar-preview').style.display = 'block';
                progressBar.style.display = 'none';
                uploadContainer.classList.add('success');
                showNotification('Avatar uploaded successfully!');
            }
        }

        async function saveItem() {
            // Validate required fields
            let isValid = true;
            
            if (currentView === 'posts' || currentView === 'featured') {
                const title = document.getElementById('title').value;
                const slug = document.getElementById('slug').value;
                const authorId = document.getElementById('author_id').value;
                const categoryId = document.getElementById('category_id').value;
                
                if (!title || !slug || !authorId || !categoryId) {
                    showNotification('Please fill in all required fields', 'error');
                    isValid = false;
                }
                
                if (!validateSlug(slug)) {
                    document.getElementById('slug').closest('.form-group').classList.add('error');
                    showNotification('Invalid slug format', 'error');
                    isValid = false;
                }
                
                if (isValid) {
                    const content = quill.root.innerHTML;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const wordCount = tempDiv.innerText.split(/\s+/).filter(Boolean).length;
                    
                    // Get the current highest order_index if creating a new post
                    let orderIndex = 0;
                    if (!editingId) {
                        const { data: posts } = await supabaseClient
                            .from('posts')
                            .select('order_index')
                            .order('order_index', { ascending: false })
                            .limit(1);
                        
                        if (posts && posts.length > 0) {
                            orderIndex = posts[0].order_index + 1;
                        }
                    }
                    
                    const itemData = {
                        title: title,
                        slug: slug,
                        excerpt: document.getElementById('excerpt').value,
                        content: content,
                        word_count: wordCount,
                        image_url: document.getElementById('image_url').value,
                        author_id: authorId,
                        category_id: categoryId,
                        is_featured: document.getElementById('is_featured').checked,
                        order_index: editingId ? undefined : orderIndex
                    };
                    
                    const { error } = editingId
                        ? await supabaseClient.from('posts').update(itemData).eq('id', editingId)
                        : await supabaseClient.from('posts').insert([itemData]);
                    
                    if (error) {
                        showNotification('Error: ' + error.message, 'error');
                    } else {
                        // Show success message with preview link
                        const previewUrl = `../article.html?post=${slug}`;
                        const successMessage = editingId 
                            ? `Post updated successfully! <a href="${previewUrl}" target="_blank" class="preview-link"><i class="fas fa-eye"></i> Preview</a>`
                            : `Post created successfully! <a href="${previewUrl}" target="_blank" class="preview-link"><i class="fas fa-eye"></i> Preview</a>`;
                        
                        showNotification(successMessage);
                        switchView(currentView);
                    }
                }
            } else if (currentView === 'categories') {
                const name = document.getElementById('name').value;
                const slug = document.getElementById('slug').value;
                
                if (!name || !slug) {
                    showNotification('Please fill in all required fields', 'error');
                    isValid = false;
                }
                
                if (!validateSlug(slug)) {
                    document.getElementById('slug').closest('.form-group').classList.add('error');
                    showNotification('Invalid slug format', 'error');
                    isValid = false;
                }
                
                if (isValid) {
                    const parentId = document.getElementById('parent_id').value;
                    const itemData = { 
                        name: name, 
                        slug: slug, 
                        parent_id: parentId || null 
                    };
                    
                    const { error } = editingId
                        ? await supabaseClient.from('categories').update(itemData).eq('id', editingId)
                        : await supabaseClient.from('categories').insert([itemData]);
                    
                    if (error) {
                        showNotification('Error: ' + error.message, 'error');
                    } else {
                        showNotification(`Category ${editingId ? 'updated' : 'created'} successfully!`);
                        switchView(currentView);
                    }
                }
            } else if (currentView === 'authors') {
                const fullName = document.getElementById('full_name').value;
                
                if (!fullName) {
                    showNotification('Please fill in all required fields', 'error');
                    isValid = false;
                }
                
                if (isValid) {
                    const itemData = { 
                        full_name: fullName, 
                        bio: document.getElementById('bio').value,
                        avatar_url: document.getElementById('avatar_url').value
                    };
                    
                    const { error } = editingId
                        ? await supabaseClient.from('authors').update(itemData).eq('id', editingId)
                        : await supabaseClient.from('authors').insert([itemData]);
                    
                    if (error) {
                        showNotification('Error: ' + error.message, 'error');
                    } else {
                        showNotification(`Author ${editingId ? 'updated' : 'created'} successfully!`);
                        switchView(currentView);
                    }
                }
            }
        }

        // Save contact page information
        async function saveContact() {
            const contactData = {
                email: document.getElementById('contact_email').value,
                phone: document.getElementById('contact_phone').value,
                address: document.getElementById('contact_address').value
            };
            
            // Check if we're updating or inserting
            const { data: existingData } = await supabaseClient
                .from('contact_page')
                .select('id')
                .single();
            
            let result;
            if (existingData) {
                result = await supabaseClient
                    .from('contact_page')
                    .update(contactData)
                    .eq('id', existingData.id);
            } else {
                result = await supabaseClient
                    .from('contact_page')
                    .insert([contactData]);
            }
            
            if (result.error) {
                showNotification('Error saving contact information: ' + result.error.message, 'error');
            } else {
                showNotification('Contact information saved successfully!');
            }
        }

        async function deleteItem(id) {
            if (confirm('Are you sure? This cannot be undone.')) {
                const { error } = await supabaseClient.from(currentView).delete().eq('id', id);
                if (error) {
                    showNotification('Error: ' + error.message, 'error');
                } else {
                    showNotification(`${currentView.slice(0, -1)} deleted successfully`);
                    loadData();
                }
            }
        }
        
        async function editItem(id) {
            editingId = id;
            // If we're editing from the featured view, we need to set the current view to 'posts' to use the post form
            if (currentView === 'featured') {
                currentView = 'posts';
            }
            const { data } = await supabaseClient.from(currentView).select('*').eq('id', id).single();
            renderForm(data);
        }

        navLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            switchView(e.target.closest('.nav-link').dataset.view);
        }));
        
        createNewBtn.addEventListener('click', () => {
            editingId = null;
            renderForm();
        });

        // Initialize with dashboard
        switchView('dashboard');
    </script>

</body>
</html>
